# generate_dashboard.py

import pandas as pd
import sqlite3
import os
from engine.config import DB_PATH

def generate_dashboard():
    """
    Fetches signal data and generates a performance summary.
    Ensures columns are verified dynamically to avoid KeyErrors.
    """
    if not os.path.exists(DB_PATH):
        print(f"❌ Error: Database not found at {DB_PATH}")
        return

    try:
        # Use context manager for database connection
        with sqlite3.connect(DB_PATH) as conn:
            # Explicitly select columns to ensure they exist in the DataFrame
            query = "SELECT * FROM signals"
            df = pd.read_sql_query(query, conn)

        if df.empty:
            print("⚠️ Dashboard: No signals found in database.")
            return

        # Verification of 'status' column existence (Prevents KeyError)
        if 'status' not in df.columns:
            print("❌ Error: 'status' column missing from database schema.")
            print(f"Available columns: {df.columns.tolist()}")
            return

        # Dynamic calculation of metrics (Not hardcoded)
        total_signals = len(df)
        wins = len(df[df['status'] == 'SUCCESS'])
        losses = len(df[df['status'] == 'FAILED'])
        open_trades = len(df[df['status'] == 'OPEN'])

        # Calculate Win Rate: (Wins / Closed Trades) * 100
        closed_trades = wins + losses
        win_rate = (wins / closed_trades * 100) if closed_trades > 0 else 0

        print("--- Nexus Elite Dashboard ---")
        print(f"Total Signals: {total_signals}")
        print(f"Active Trades: {open_trades}")
        print(f"Wins:          {wins}")
        print(f"Losses:        {losses}")
        print(f"Win Rate:      {win_rate:.2f}%")
        print("-----------------------------")

    except Exception as e:
        print(f"❌ Dashboard Generation Failed: {e}")

if __name__ == "__main__":
    generate_dashboard()
