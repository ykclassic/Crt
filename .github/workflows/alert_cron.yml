name: nexus_operations

on:
  schedule:
    - cron: "0 * * * *"   # Runs every hour
  workflow_dispatch:

jobs:
  nexus:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # 1Ô∏è‚É£ Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required for rebase

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # 3Ô∏è‚É£ Install Dependencies (Upgraded)
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade ccxt
          pip install -r requirements.txt

      # 4Ô∏è‚É£ Database Schema Migration
      - name: Database Schema Migration
        run: |
          python sanity_check.py

      # 5Ô∏è‚É£ Maintenance
      - name: Run Maintenance
        run: |
          python maintenance.py

      # 6Ô∏è‚É£ Market Guardian
      - name: Run Market Guardian
        run: |
          python market_guardian.py

      # 7Ô∏è‚É£ Core Engines
      - name: Run AI Engine
        run: python ai_engine.py

      - name: Run Hybrid Engine
        run: python hybrid_engine.py

      - name: Run Range Engine
        run: python range_engine.py

      - name: Run Nexus Core
        run: python nexus_core.py

      # 8Ô∏è‚É£ Consensus & Dispatcher
      - name: Run Consensus
        run: python run_consensus.py

      - name: Run Dispatcher
        run: python nexus_dispatcher.py

      # 9Ô∏è‚É£ Auditor & Reconciliation
      - name: Run Auditor
        run: python audit_intelligence.py

      - name: Run Recon Engine
        run: python recon_engine.py

      # üîü AI Retraining
      - name: Retrain AI Brain
        run: python train_brain.py

      # 1Ô∏è‚É£1Ô∏è‚É£ Commit & Push (Safe Rebase)
      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # Pull latest changes safely
          git pull origin main --rebase

          git add .

          git commit -m "üîÑ Nexus Auto Update - $(date -u +"%Y-%m-%d %H:%M:%S")" \
          || echo "No changes to commit"

          git push origin main

      # 1Ô∏è‚É£2Ô∏è‚É£ Completion
      - name: Complete Job
        run: echo "Nexus operation cycle complete."
