name: Nexus Intelligence Suite

on:
  schedule:
    - cron: '0 * * * *'       # Hourly: Run all engines + consensus + dispatcher
    - cron: '0 0 * * *'       # Daily: Retrain AI brain (midnight UTC)
    - cron: '0 20 * * 0'      # Weekly Report: Every Sunday 8PM UTC
    - cron: '0 20 1 * *'      # Monthly Report: 1st of the month 8PM UTC
  workflow_dispatch:         # Manual trigger for instant run/report

permissions:
  contents: write            # Required for pushing database updates back to the repo

jobs:
  nexus-ops:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # Necessary for clean rebase logic

      - name: Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install pandas ccxt requests plotly streamlit \
                      numpy xgboost scikit-learn

      - name: Pre-Flight Sanity Check
        run: python sanity_check.py

      - name: Hourly Intelligence Cycle
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 * * * *')
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Core Engines
          python run_alerts.py          
          python ai_engine.py

          # Logic Layer
          python run_consensus.py
          python nexus_dispatcher.py
          python audit_intelligence.py

      - name: Daily AI Retraining
        if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
        run: |
          if [ -f "train_brain.py" ]; then python train_brain.py; fi

      - name: Generate & Send Reports
        if: >
          github.event_name == 'workflow_dispatch' ||
          github.event.schedule == '0 20 * * 0' ||
          github.event.schedule == '0 20 1 * *'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python nexus_reporter.py --full

      - name: Daily Maintenance
        if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
        run: |
          python maintenance.py

      - name: Sync Data to Repo
        if: always()          # Run even if a strategy engine has a minor failure
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Use wildcards and silence errors to avoid 'pathspec' exit code 128
          # This stages only what actually exists
          git add *.db *.json *.pkl 2>/dev/null || echo "No data files found to stage."
          
          if git diff --cached --quiet; then
            echo "No data changes detected. Skipping sync."
          else
            git commit -m "Auto-sync: Intelligence update $(date +'%Y-%m-%d %H:%M UTC')"
            git pull --rebase origin main
            git push origin main
          fi
